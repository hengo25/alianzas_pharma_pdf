<!-- templates/productos.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Productos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .producto-card { border:1px solid #333; padding:12px; border-radius:6px; background:#fff; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; }
    .producto-card img { max-width:100%; max-height:150px; object-fit:contain; margin-bottom:8px; }
    .producto-nombre { font-weight:bold; text-transform:uppercase; font-style:italic; font-size:0.95rem; text-align:center; min-height:46px; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold">üì¶ Gesti√≥n de Productos</h2>
    <a href="{{ url_for('index') }}" class="btn btn-secondary">üè† Inicio</a>
  </div>

  <form class="row g-2 mb-3" method="get" action="{{ url_for('productos') }}">
    <div class="col-auto flex-fill">
      <input type="text" name="q" class="form-control" placeholder="Buscar..." value="{{ q }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary">Buscar</button>
    </div>
    <div class="col-auto">
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAgregar">+ Nuevo</button>
    </div>
    <div class="col-auto">
      <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('modalSeleccion').style.display='flex'">Exportar PDF</button>
    </div>
  </form>

  <!-- grid 3 columnas -->
  <div class="row g-3">
    {% for p in productos %}
    <div class="col-md-4">
      <div class="producto-card">
        <img src="{{ p['imagen'] }}" alt="imagen">
        <div class="producto-nombre mt-2">{{ p['nombre'] }}</div>
        <div class="mt-2 text-muted">${{ p['precio'] }}</div>
        <div class="mt-3 w-100 d-flex justify-content-center gap-2">
          <form method="post" action="{{ url_for('productos_eliminar', id=p['id']) }}" onsubmit="return confirm('¬øEliminar este producto?')">
            <button class="btn btn-danger btn-sm">üóë</button>
          </form>

          <button class="btn btn-warning btn-sm btn-editar"
                  data-id="{{ p['id'] }}"
                  data-nombre="{{ p['nombre']|escape }}"
                  data-precio="{{ p['precio'] }}"
                  data-imagen="{{ p['imagen'] }}">
            ‚úè
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- paginaci√≥n simple -->
  <div class="mt-4 d-flex justify-content-center">
    <nav>
      <ul class="pagination">
        {% for i in range(1, total_paginas+1) %}
        <li class="page-item {% if i==pagina_actual %}active{% endif %}">
          <a class="page-link" href="?pagina={{ i }}&por_pagina={{ por_pagina }}{% if q %}&q={{ q }}{% endif %}">{{ i }}</a>
        </li>
        {% endfor %}
      </ul>
    </nav>
  </div>
</div>

<!-- MODAL SELECCI√ìN (flotante) -->
<div id="modalSeleccion" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:18px;border-radius:8px;width:90%;max-width:1100px;max-height:85%;overflow:auto;">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>Seleccionar productos para PDF</h5>
      <button class="btn btn-sm btn-danger" onclick="document.getElementById('modalSeleccion').style.display='none'">‚úñ</button>
    </div>

    <div class="mb-2">
      <button class="btn btn-sm btn-success" onclick="seleccionarTodo()">Seleccionar todo</button>
      <button class="btn btn-sm btn-secondary" onclick="deseleccionarTodo()">Deseleccionar todo</button>
    </div>

    <form id="formPDF" method="post" action="{{ url_for('productos_pdf') }}">
      <div class="row g-3">
        {% for p in todos_productos %}
        <div class="col-md-3 col-6 text-center">
          <div style="border:1px solid #ddd;padding:10px;border-radius:6px;">
            <img src="{{ p['imagen'] }}" style="width:120px;height:120px;object-fit:contain">
            <div class="fw-bold mt-2" style="font-size:0.9rem">{{ p['nombre'] }}</div>
            <div class="text-muted">${{ p['precio'] }}</div>
            <div class="form-check mt-1">
              <input class="form-check-input" type="checkbox" name="productos_seleccionados" value="{{ p['id'] }}">
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="mt-3">
        <button class="btn btn-primary w-100">Generar PDF</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL AGREGAR (bootstrap) -->
<div class="modal fade" id="modalAgregar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{{ url_for('productos_agregar') }}" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Nuevo producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input class="form-control mb-2" name="nombre" placeholder="Nombre" required>
          <input class="form-control mb-2" name="precio" placeholder="Precio" type="number" step="0.01" required>
          <input class="form-control mb-2" name="imagen" type="file" accept="image/*" required>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MODAL EDITAR (bootstrap) -->
<div class="modal fade" id="modalEditar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formEditar" method="post" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Editar producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="editNombre" name="nombre" class="form-control mb-2" required>
          <input type="number" id="editPrecio" name="precio" class="form-control mb-2" required>
          <div class="mb-2">
            <label>Imagen actual</label><br>
            <img id="editImagenActual" style="width:120px;height:120px;object-fit:contain">
          </div>
          <input type="file" name="imagen" class="form-control">
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary">Actualizar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.querySelectorAll('.btn-editar').forEach(btn => {
  btn.addEventListener('click', () => {
    const id = btn.dataset.id;
    const nombre = btn.dataset.nombre;
    const precio = btn.dataset.precio;
    const imagen = btn.dataset.imagen;
    document.getElementById('editNombre').value = nombre;
    document.getElementById('editPrecio').value = precio;
    document.getElementById('editImagenActual').src = imagen;
    document.getElementById('formEditar').action = '/productos/editar/' + id;
    new bootstrap.Modal(document.getElementById('modalEditar')).show();
  });
});

function seleccionarTodo() {
  document.querySelectorAll('#formPDF input[type=checkbox]').forEach(c => c.checked = true);
}
function deseleccionarTodo() {
  document.querySelectorAll('#formPDF input[type=checkbox]').forEach(c => c.checked = false);
}
</script>
</body>
</html>
